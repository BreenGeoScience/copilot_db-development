# Instructions: How to Guide Chat Assistance After Stage Schema and Fuzzy Allocation Integration

## Purpose

These instructions explain the updated setup for handling fuzzy allocation mapping, category and GL account assignment, and the new `stage` schema in your Postgres database. Follow this workflow to bring a new AI assistant (ChatGPT/Copilot Chat) up to your current system state after recent changes—especially around personal/business budgeting, keyword learning, and mappings.

---

## Latest Database and Table Structure

### 1. **Keyword & Account Mapping Table**
- **Table is now:** `stage.fuzzy_allocation_map`
- **Columns:** `id`, `keyword`, `gl_account_code`, `category`
  - `category` is new and must always be lower case.

### 2. **Bank Import Target Table**
- **Table is now:** `stage.tier1_stage`
- All historical transactions & new bank CSV imports now go here, using the same import structure as previous `acc.bank_staging`.
- Table columns unchanged.

---

## Python Fuzzy Assignment Script

### **Script location:** `copilot/commands/fuzzy.py`

### **How it works:**
1. **Auto-Fuzzy Matching**
   - For each staging row with `gl_account_code = 'TODO'` and blank/null `mod_fuzzy`:
       - Updates **both** `gl_account_code` and `category` in `stage.tier1_stage` when a fuzzy (substring) match is found in either `description` or `category`.  
       - `category` is set to the mapped value (if present in `fuzzy_allocation_map`), otherwise the matched keyword (lowercase).

2. **Manual Learning**
   - For each row where user sets `mod_fuzzy = '1'` in `stage.tier1_stage`:
       - Learns all words (and full field) from `description` and `category`.
       - For each (keyword, gl_account_code), it **inserts or updates** (with new `category`) in `stage.fuzzy_allocation_map`.
       - All learned/updated categories are forced to lower case.
       - Clears `mod_fuzzy` flag in `stage.tier1_stage` after processing.

3. **Schema Hardcoding**
   - All database references in the script point to the `stage` schema, not `acc`.

---

## Migration: Moving the Mapping Table

**If you ever need to re-create or copy the mapping table:**

```sql
-- Create (with new `category` col as NULL)
DROP TABLE IF EXISTS stage.fuzzy_allocation_map;
CREATE TABLE stage.fuzzy_allocation_map AS
SELECT
  ROW_NUMBER() OVER (ORDER BY keyword, gl_account_code) AS id,
  keyword,
  gl_account_code,
  NULL::text AS category
FROM (
  SELECT DISTINCT ON (keyword, gl_account_code) keyword, gl_account_code
  FROM acc.fuzzy_allocation_map
  ORDER BY keyword, gl_account_code
) AS deduped;
```
- This creates an empty `category` field for future growth (already required by the script).

---

## Budgeting & Reporting Workflow

- From now on: **Personal/business budgeting and reporting should use both fields**:
    - `gl_account_code` for precise account/class tracking (e.g. `csb:account`)
    - `category` for high-level grouping/semantic tag (e.g. `owner distribution`, `utilities`)
- Both are batch-assignable using the fuzzy script and learnable through manual review + `mod_fuzzy`.
- Mapping table acts as your "ruleset" for future import auto-matching.

---

## What to Tell Chat (Copilot) to Continue

**Instruct Chat:**
1. My setup uses `stage.tier1_stage` for staging and `stage.fuzzy_allocation_map` for mapping.
2. I want all fuzzy assignment and manual learning to update both `gl_account_code` and `category` (with category always lower case).
3. The mapping table includes: `id`, `keyword`, `gl_account_code`, `category`.
4. Ask for scripts or SQLs tailored to the `stage` schema—not `acc`.
5. For budgeting/reporting logic, reference both `category` and `gl_account_code` as described here.
6. If you need to clean up for duplicates or missing `category`, ask for assistance to deduplicate or batch-update accordingly.

---

## Example Prompt to Resume

> My allocation and staging tables are now in the `stage` schema. Fuzzy logic should always set both `gl_account_code` and a lower-case `category`. Continue the workflow for personal and business budgeting/reporting.

---

Understood—from now on, whenever you ask to add, append, or modify files, I will generate the exact Bash/terminal commands or scripting (such as using cat or echo to >> or > in a file) so you can copy-paste into your terminal with NO manual editing, unless you instruct otherwise.

You will ALWAYS get literal, ready-to-execute terminal scripts for any file changes requested—no explanations, just the commands/blocks.

If you want a different mode, just tell me.

From this point forward:
Whenever you request to add, append, or modify any file, I will reply ONLY with the literal Bash/terminal commands or script blocks (using cat, echo, >>, >, etc) to make the file changes, ready for you to copy-paste directly, WITHOUT ANY explanations or extra commentary.

If you want output in a different style, just say so in your instructions.

---



**With these notes, any assistant can pick up exactly where you left off!**






